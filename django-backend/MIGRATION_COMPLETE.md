# ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `unified-backend` —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ Django –±—ç–∫–µ–Ω–¥.

## üì¶ –ß—Ç–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ

### ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤**
   - `get_products()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ API Kaspi
   - `sync_store_api()` - –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
   - `insert_product_if_not_exists()` - –≤—Å—Ç–∞–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤

2. **–ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤**
   - `parse_product_by_sku()` - –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞ –ø–æ SKU
   - `sync_product()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞ –≤ Kaspi

3. **–î–µ–º–ø–µ—Ä —Ü–µ–Ω**
   - Management command `python manage.py demper`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤

4. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**
   - Email/Password –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Playwright)
   - SMS –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (`sms_login_start`, `sms_login_verify`)
   - SessionManager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏

5. **–ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã**
   - `fetch_preorders()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤
   - `handle_upload_preorder()` - –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Kaspi
   - `generate_preorder_xlsx()` - —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel

6. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã**
   - Proxy –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
   - Error handlers –¥–ª—è Playwright
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
django-backend/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_service.py      # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ parser_service.py    # –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ proxy_service.py     # Proxy –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ management/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ commands/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ demper.py         # –î–µ–º–ø–µ—Ä —Ü–µ–Ω
‚îÇ   ‚îú‚îÄ‚îÄ models.py                 # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ views.py                  # API endpoints
‚îÇ   ‚îî‚îÄ‚îÄ serializers.py            # –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã
‚îú‚îÄ‚îÄ kaspi_auth/
‚îÇ   ‚îú‚îÄ‚îÄ kaspi_auth_service.py     # Playwright –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ sms_auth_service.py       # SMS –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ session_manager.py        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ error_handlers.py         # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îî‚îÄ‚îÄ views.py                  # Auth endpoints
‚îî‚îÄ‚îÄ preorders/
    ‚îî‚îÄ‚îÄ services.py               # –°–µ—Ä–≤–∏—Å—ã –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤
```

## üîå API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/v1/kaspi/auth/authenticate/` - Email/Password –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- `POST /api/v1/kaspi/auth/sms_start/` - –ù–∞—á–∞–ª–æ SMS –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `POST /api/v1/kaspi/auth/sms_verify/` - –ü—Ä–æ–≤–µ—Ä–∫–∞ SMS –∫–æ–¥–∞

### –ú–∞–≥–∞–∑–∏–Ω—ã
- `GET /api/v1/kaspi/stores/?user_id=<uuid>` - –°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤
- `POST /api/v1/kaspi/stores/{id}/sync/` - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤

### –¢–æ–≤–∞—Ä—ã
- `GET /api/v1/products/` - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
- `POST /api/v1/products/offers_by_product/` - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–æ–≤ –ø–æ SKU
- `POST /api/v1/products/update_price/` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞
- `POST /api/v1/products/batch_enable/` - –ú–∞—Å—Å–æ–≤–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ
- `POST /api/v1/products/batch_disable/` - –ú–∞—Å—Å–æ–≤–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ

### –ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã
- `GET /api/v1/preorders/list_by_store/?store_id=<uuid>` - –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤
- `POST /api/v1/preorders/upload/` - –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Kaspi
- `POST /api/v1/preorders/generate_excel/` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–µ–º–ø–µ—Ä —Ü–µ–Ω
```bash
# –ó–∞–ø—É—Å–∫ –æ–¥–∏–Ω —Ä–∞–∑
python manage.py demper --once

# –ó–∞–ø—É—Å–∫ –≤ —Ü–∏–∫–ª–µ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
python manage.py demper --interval 5
```

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
```bash
POST /api/v1/kaspi/stores/{store_id}/sync/
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞
```bash
POST /api/v1/products/update_price/
Body: {
    "product_id": "uuid",
    "price": 1000.00
}
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Async —Ñ—É–Ω–∫—Ü–∏–∏**: –í—Å–µ async —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–µ—Ä–Ω—É—Ç—ã —á–µ—Ä–µ–∑ `run_async()` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Django

2. **Proxy**: –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è proxy —Å–µ—Ä–≤–∏—Å–∞. –î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ `unified-backend/proxy_balancer.py`

3. **SMS —Å–µ—Å—Å–∏–∏**: –•—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (`sms_sessions` dict). –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis

4. **–î–µ–º–ø–µ—Ä**: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ management command. –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Celery

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã
2. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
3. ‚è≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ production –æ–∫—Ä—É–∂–µ–Ω–∏—è
4. ‚è≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Celery –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
5. ‚è≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ SMS —Å–µ—Å—Å–∏–π

## üóëÔ∏è –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å unified-backend

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å `unified-backend/`, —Ç–∞–∫ –∫–∞–∫ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã!

```bash
# –°–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
mkdir -p archive
cp -r unified-backend archive/

# –£–¥–∞–ª–∏—Ç—å
rm -rf unified-backend/
```

