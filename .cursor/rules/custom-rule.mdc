---
alwaysApply: true
---
# KASPI API PARSER ‚Äî –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è Cursor IDE

## –Ø–∑—ã–∫ –∏ —Å—Ç–∏–ª—å
- **–Ø–∑—ã–∫**: –†—É—Å—Å–∫–∏–π. –í—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ª–æ–≥–∏, —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
- **–°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–æ–≤**: –¢–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –û–±—ä—è—Å–Ω–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
- **–§–æ—Ä–º–∞—Ç –∫–æ–¥–∞**: Python 3.13+, async/await, type hints –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–æ–∏
1. **SessionManager** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏, cookies, –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
2. **API Layer** ‚Äî –∑–∞–ø—Ä–æ—Å—ã –∫ Kaspi —á–µ—Ä–µ–∑ aiohttp, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
3. **DB Layer** ‚Äî asyncpg –¥–ª—è PostgreSQL (–ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
4. **Parser Layer** ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤, –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤, –∑–∞–∫–∞–∑–æ–≤
5. **Upload Layer** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (XLSX, price feeds)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `kaspi_stores` ‚Äî –º–∞–≥–∞–∑–∏–Ω—ã (user_id, merchant_id, cookies, last_login)
- `products` ‚Äî —Ç–æ–≤–∞—Ä—ã (kaspi_sku, price, category, image_url)
- `preorders` ‚Äî –ø—Ä–µ–¥–∑–∞–∫–∞–∑—ã (product_id, store_id, warehouses, delivery_days)
- `orders` ‚Äî –∑–∞–∫–∞–∑—ã (date, count, amount, top_products)

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- **Playwright** ‚Äî –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ SMS-–≤—Ö–æ–¥–∞
- **aiohttp** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã —Å proxy
- **asyncpg** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL
- **pandas** ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –≤ XLSX
- **FastAPI** ‚Äî REST API (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- **requests** ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã (–≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)

---

## –ü—Ä–∞–≤–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞

### 1. –¶–µ–ª–µ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ **–†–µ–¥–∞–∫—Ç–∏—Ä—É–π –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ —É–∫–∞–∑–∞–Ω–æ:**
- –ù–∞–ø—Ä–∏–º–µ—Ä: "–ò—Å–ø—Ä–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ –º–µ—Ç–æ–¥–µ `is_session_valid()`" ‚Üí –º–µ–Ω—è–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥
- –ù–µ —Ç—Ä–æ–≥–∞–π –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–∞, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ
- –ù–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞

‚ùå **–ù–µ –¥–µ–ª–∞–π:**
- –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ–≥–æ –∫–ª–∞—Å—Å–∞
- –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞
- –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–¥–∞ "–¥–ª—è —á–∏—Å—Ç–æ—Ç—ã"

### 2. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
–ü–µ—Ä–µ–¥ –ª—é–±—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –Ω–∞–ø–∏—à–∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:


–ü–†–û–í–ï–†–ö–ê:
- –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ –ª–∏ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ –ª–∏ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (logger –∏–ª–∏ ErrorHandler):

```python
logger.info(f"üîç [COMPONENT] –í—ã–ø–æ–ª–Ω—è—é –¥–µ–π—Å—Ç–≤–∏–µ...")
logger.warning(f"‚ö†Ô∏è [COMPONENT] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ...")
logger.error(f"‚ùå [COMPONENT] –û—à–∏–±–∫–∞: {error}")
```

–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚Äî —á–µ—Ä–µ–∑ try/except —Å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏:
```python
try:
    # –∫–æ–¥
except asyncpg.PostgresError as e:
    logger.error(f"DB –æ—à–∏–±–∫–∞: {e}")
    raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ë–î: {str(e)}")
except aiohttp.ClientError as e:
    logger.error(f"HTTP –æ—à–∏–±–∫–∞: {e}")
    raise
```

---

## –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–µ—Ç–æ–¥–æ–≤

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- **async —Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî –¥–ª—è DB, HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤, Playwright
- –ò—Å–ø–æ–ª—å–∑—É–π `asyncpg.pool.Pool` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ù–µ –±–ª–æ–∫–∏—Ä—É–π event loop —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

–ü—Ä–∏–º–µ—Ä ‚úÖ:
```python
async def get_products(cookies: dict, merchant_uid: str) -> list[dict]:
    async with ClientSession() as session:
        async with session.get(url, ...) as response:
            return await response.json()
```

### Type hints
```python
async def fetch_preorders(
    store_id: str,
    *,
    pool: Optional[asyncpg.pool.Pool] = None,
    limit: Optional[int] = None
) -> list[dict]:
```

### –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
–ü—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Kaspi:
1. –ü—Ä–æ–≤–µ—Ä—è–π –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–π: `dict.get('key', default_value)`
2. –¢–∏–ø–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ: `int(value)`, `float(price)`
3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏—è JSON: `json.JSONDecodeError`

–ü—Ä–∏–º–µ—Ä:
```python
def map_offer(raw_offer: dict) -> dict:
    price_val = raw_offer.get("minPrice", {})
    try:
        price = float(price_val) if price_val else 0
    except (ValueError, TypeError):
        price = 0
    return {"price": price, ...}
```

---

## –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SessionManager

### –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
```python
session_manager = SessionManager(shop_uid=store_id)
if not await session_manager.load():
    raise HTTPException(status_code=401, detail="–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞")

cookies = session_manager.get_cookies()
merchant_uid = session_manager.merchant_uid
```

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
```python
session_manager = SessionManager(user_id)
await session_manager.save(cookies, email, password)
```

---

## –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤

### Headers
–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–∫–∞–∫ –≤ –∫–æ–¥–µ):
```python
headers = {
    "x-auth-version": "3",
    "Origin": "https://kaspi.kz",
    "User-Agent": "Mozilla/5.0 ...",
    "Accept": "application/json, text/plain, */*",
}
```

### Proxy
–í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–π proxy —á–µ—Ä–µ–∑ `proxy_balancer`:
```python
proxy_dict = proxy_balancer.get_balanced_proxy(f"sku_{sku}")
proxy_url = _proxy_url(proxy_dict)
async with session.get(url, proxy=proxy_url, ...) as response:
    pass
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
```python
if response.status == 401:
    logger.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏")
    raise HTTPException(...)
elif response.status == 429:
    logger.warning("Rate limit")
    raise Exception("Too Many Requests")
response.raise_for_status()
```

---

## –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (asyncpg)

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–ª–∞
```python
pool = await create_pool()
async with pool.acquire() as conn:
    row = await conn.fetchrow("SELECT ... WHERE id = $1", id_value)
```

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```python
async with conn.transaction():
    # CHECK + INSERT/UPDATE –±–µ–∑ –≥–æ–Ω–æ–∫
    existing = await conn.fetchval("SELECT 1 FROM ... WHERE ...", ...)
    if existing:
        return {"status": "already_exists"}
    await conn.execute("INSERT ...", ...)
```

### –¢–∏–ø—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `fetchval()` ‚Üí —Å–∫–∞–ª—è—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- `fetchrow()` ‚Üí –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –∫–∞–∫ Record (dict-–ø–æ–¥–æ–±–Ω—ã–π)
- `fetch()` ‚Üí —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫
- `execute()` ‚Üí None (–¥–ª—è INSERT/UPDATE)

---

## –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –¥–∏–∑–∞–π–Ω–∞ –∏ UI –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥:
- **–†–µ–¥–∞–∫—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** ‚Äî —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –Ω–µ –∫–∞—Å–∞–π—Å—è —Å–æ—Å–µ–¥–Ω–∏—Ö
- –ü—Ä–∏–º–µ—Ä: "–°–¥–µ–ª–∞–π –∫–Ω–æ–ø–∫—É –∫—Ä—É–≥–ª–æ–π –≤–º–µ—Å—Ç–æ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π" ‚Üí –º–µ–Ω—è–µ—à—å —Ç–æ–ª—å–∫–æ CSS/props —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏
- **–°—Ç–∏–ª–∏** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É (–µ—Å–ª–∏ Tailwind, Material, —Ç–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è)

---

## –ü—Ä–∏–º–µ—Ä—ã —á–∞—Å—Ç—ã—Ö –∑–∞–¥–∞—á

### 1. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é
```python
# –ü–õ–ê–ù: –¥–æ–±–∞–≤–∏—Ç—å logger.info –≤ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

async def get_products(cookies: dict, merchant_uid: str):
    logger.info(f"üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è {merchant_uid}")
    # ... –∫–æ–¥ ...
    logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(all_offers)}")
    return all_offers
```

### 2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏ –≤ –º–µ—Ç–æ–¥–µ
```python
# –ü–õ–ê–ù: –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É KeyError –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ raw_offer

def map_offer(raw_offer: dict) -> dict:
    try:
        external_kaspi_id = match.group(1) if match else None
    except (AttributeError, IndexError):
        external_kaspi_id = None
    return {...}
```

### 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –ë–î
```python
# –ü–õ–ê–ù: –¥–æ–±–∞–≤–∏—Ç—å LIMIT –≤ –∑–∞–ø—Ä–æ—Å, –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –Ω–∞ fetchval –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏

async def get_product_count(store_id: str) -> int:
    async with pool.acquire() as conn:
        count = await conn.fetchval(
            "SELECT COUNT(*) FROM products WHERE store_id = $1 LIMIT 1",
            store_id
        )
    return count or 0
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ –í—Å–µ async —Ñ—É–Ω–∫—Ü–∏–∏ –æ–∂–∏–¥–∞—é—Ç—Å—è (await)
- ‚úÖ Type hints –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –º–µ—Å—Ç–µ
- ‚úÖ –ö–æ–¥ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–π **f-strings** –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π **list comprehensions** –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–æ–≤ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–π **context managers** (async with, with) –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π —Å–ª–æ–∂–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã docstring'–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
