# HOW_IT_WORKS.md
# –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç WAHA –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kaspi Demper

## üîÑ –û–±—â–∞—è —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```
Kaspi API ‚Üí api_parser.py ‚Üí WAHA Module ‚Üí WAHA Server ‚Üí WhatsApp ‚Üí –ü–æ–∫—É–ø–∞—Ç–µ–ª—å
    ‚Üì              ‚Üì              ‚Üì              ‚Üì
  –ó–∞–∫–∞–∑—ã      get_sells()    process_orders()   send_message()
```

## üìã –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

### 1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Kaspi**

**–§–∞–π–ª:** `/Users/hasen/demper-667-45/kaspi-demper-main/backend/api_parser.py`

**–§—É–Ω–∫—Ü–∏—è:** `get_sells(shop_id)` (—Å—Ç—Ä–æ–∫–∏ 940-945)

```python
async def get_sells(shop_id):
    session_manager = SessionManager(shop_uid=shop_id)
    if not await session_manager.load():
        return False, '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.'
    cookies = session_manager.get_cookies()
    return True, get_sells_delivery_request(session_manager.merchant_uid, cookies)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è Kaspi –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
2. –ü–æ–ª—É—á–∞—é—Ç—Å—è cookies –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `get_sells_delivery_request()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–∞—Ö
4. –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö

### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤**

**–§—É–Ω–∫—Ü–∏—è:** `get_sells_delivery_request()` (—Å—Ç—Ä–æ–∫–∏ 902-937)

```python
def get_sells_delivery_request(merchant_id: str, cookies: dict):
    headers = {
        "accept": "application/json, text/*",
        "accept-encoding": "gzip, deflate, br, zstd",
        "accept-language": "ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7",
        "cache-control": "no-cache",
        "connection": "keep-alive",
        "content-type": "application/json; charset=UTF-8",
        "host": "mc.shop.kaspi.kz",
        "origin": "https://kaspi.kz",
        "pragma": "no-cache",
        "referer": "https://kaspi.kz/",
        "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "x-ks-city": "750000000",
    }

    urls = [
        f"https://mc.shop.kaspi.kz/mc/api/orderTabs/active?count=100&selectedTabs=DELIVERY&startIndex=0&loadPoints=false&_m={merchant_id}",
        f"https://mc.shop.kaspi.kz/mc/api/orderTabs/active?count=100&selectedTabs=PICKUP&startIndex=0&loadPoints=false&_m={merchant_id}"
    ]

    combined_json_data = []

    for url in urls:
        response_data = fetch_orders(url, headers, cookies)
        combined_json_data.extend(response_data)

    orders = map_order_data(combined_json_data)
    products = map_top_products(combined_json_data)
    metrics = calculate_metrics(combined_json_data)
    return {
        "orders": orders,
        "top_products": products,
        "metrics": metrics
    }
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –§–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–∞
2. –î–µ–ª–∞—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã –∫ –¥–≤—É–º URL (DELIVERY –∏ PICKUP –∑–∞–∫–∞–∑—ã)
3. –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö

### 3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAHA –º–æ–¥—É–ª–µ–º**

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `api_parser.py`:**

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
from waha.waha_integration import get_waha_manager
from waha.utils import get_error_handler, get_metrics_collector

# –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é get_sells()
async def get_sells(shop_id):
    session_manager = SessionManager(shop_uid=shop_id)
    if not await session_manager.load():
        return False, '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.'
    
    cookies = session_manager.get_cookies()
    result = get_sells_delivery_request(session_manager.merchant_uid, cookies)
    
    # ========== WAHA –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø ==========
    try:
        waha_manager = get_waha_manager()
        error_handler = get_error_handler()
        metrics_collector = get_metrics_collector()
        
        if waha_manager and result.get('orders'):
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑—ã –¥–ª—è WhatsApp —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            await waha_manager.process_orders_for_store(
                shop_id, 
                result.get('orders', []), 
                session_manager.shop_name or "–ú–∞–≥–∞–∑–∏–Ω"
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
            await metrics_collector.increment("orders_processed", len(result.get('orders', [])))
            
            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(result.get('orders', []))} –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è WAHA —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
            
    except Exception as e:
        error_handler.log_error(
            "waha_integration_error",
            f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ WAHA –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ {shop_id}: {e}",
            {"shop_id": shop_id, "orders_count": len(result.get('orders', []))}
        )
        logger.error(f"–û—à–∏–±–∫–∞ WAHA –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ {shop_id}: {e}")
    # ====================================
    
    return True, result
```

## üîó –°–≤—è–∑—å –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### **api_parser.py ‚Üí WAHA Module**

1. **–í—ã–∑–æ–≤:** `get_waha_manager()` –ø–æ–ª—É—á–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ WAHA
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞:** `process_orders_for_store()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑—ã
3. **–î–∞–Ω–Ω—ã–µ:** –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–µ

### **WAHA Module ‚Üí WAHA Server**

1. **–ö–ª–∏–µ–Ω—Ç:** `WAHAClient` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ WAHA —Å–µ—Ä–≤–µ—Ä—É
2. **–°–µ—Å—Å–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è WhatsApp —Å–µ—Å—Å–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
3. **API:** –í—ã–∑—ã–≤–∞—é—Ç—Å—è —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã WAHA –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### **WAHA Server ‚Üí WhatsApp**

1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** WAHA –∏—Å–ø–æ–ª—å–∑—É–µ—Ç WhatsApp Web API
2. **–û—Ç–ø—Ä–∞–≤–∫–∞:** –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
3. **–°—Ç–∞—Ç—É—Å:** –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Kaspi API:**

```json
{
  "orders": [
    {
      "orderId": "12345",
      "customerName": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
      "customerPhone": "+71234567890",
      "productName": "–¢–æ–≤–∞—Ä",
      "quantity": 2,
      "totalPrice": 5000.0,
      "deliveryType": "DELIVERY",
      "createDate": 1640995200000,
      "status": "NEW"
    }
  ],
  "top_products": [...],
  "metrics": {...}
}
```

### **–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è WAHA:**

```python
OrderData(
    customer_name="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
    customer_phone="+71234567890",
    order_id="12345",
    product_name="–¢–æ–≤–∞—Ä",
    quantity=2,
    total_amount=5000.0,
    delivery_type="–¥–æ—Å—Ç–∞–≤–∫–∞",
    order_date="01.01.2024",
    shop_name="–ú–∞–≥–∞–∑–∏–Ω"
)
```

### **–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è:**

```
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_name}!
–í–∞—à –∑–∞–∫–∞–∑ N¬∫ {order_num} "{product_name}", –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {item_qty} —à—Ç –≥–æ—Ç–æ–≤ –∫ —Å–∞–º–æ–≤—ã–≤–æ–∑—É.
* –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞.
* –°–ø–∞—Å–∏–±–æ –∑–∞ –í–∞—à –≤—ã–±–æ—Ä! –ï—Å–ª–∏ —É –í–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.
–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
{shop_name}
```

### **–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**

```
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤!
–í–∞—à –∑–∞–∫–∞–∑ N¬∫ 12345 "–¢–æ–≤–∞—Ä", –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 2 —à—Ç –≥–æ—Ç–æ–≤ –∫ —Å–∞–º–æ–≤—ã–≤–æ–∑—É.
* –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞.
* –°–ø–∞—Å–∏–±–æ –∑–∞ –í–∞—à –≤—ã–±–æ—Ä! –ï—Å–ª–∏ —É –í–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.
–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
–ú–∞–≥–∞–∑–∏–Ω
```

## üîÑ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏

### **1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è):**

```python
# main.py
@app.on_event("startup")
async def startup_event():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAHA –º–æ–¥—É–ª—è
    await initialize_waha(pool, "http://localhost:3000")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    await initialize_monitoring(waha_manager.waha_db)
```

### **2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∏–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É):**

```python
# –í—ã–∑–æ–≤ –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
success, result = await get_sells(shop_id)
```

### **3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ WAHA –º–æ–¥—É–ª–µ–º:**

```python
# waha/order_integration.py
async def process_new_orders(self, store_id: UUID, orders_data: List[Dict[str, Any]], shop_name: str):
    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    new_orders = self._filter_new_orders(orders_data)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞
    for order_data in new_orders:
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        order_info = self.extract_order_data_from_kaspi(order_data, shop_name)
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        await self.message_sender.send_order_notification(store_id, order_info)
```

### **4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**

```python
# waha/message_sender.py
async def send_order_notification(self, store_id: UUID, order_data: OrderData):
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
    template = await self.template_manager.get_active_template(store_id)
    
    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    message_text = self.template_manager.process_template(template.template_text, order_data.dict())
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WAHA
    result = await self.session_manager.send_message(str(store_id), order_data.customer_phone, message_text)
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    await self.db.log_message(message_log)
```

### **5. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WAHA API:**

```python
# waha/waha_client.py
async def send_text_message(self, session_name: str, chat_id: str, text: str):
    data = {
        "session": session_name,
        "chatId": chat_id,
        "text": text
    }
    return await self._make_request("POST", "/api/sendText", data)
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### **1. –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ api_parser.py:**

```python
# –°—Ç—Ä–æ–∫–∞ ~940 –≤ api_parser.py
async def get_sells(shop_id):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –î–û–ë–ê–í–ò–¢–¨ –ó–î–ï–°–¨:
    try:
        waha_manager = get_waha_manager()
        if waha_manager and result.get('orders'):
            await waha_manager.process_orders_for_store(
                shop_id, 
                result.get('orders', []), 
                session_manager.shop_name or "–ú–∞–≥–∞–∑–∏–Ω"
            )
    except Exception as e:
        logger.error(f"WAHA error: {e}")
    
    return True, result
```

### **2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ main.py:**

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ main.py
from waha.waha_integration import initialize_waha, get_waha_router, shutdown_waha

@app.on_event("startup")
async def startup_event():
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    await initialize_waha(pool, "http://localhost:3000")

app.include_router(get_waha_router())

@app.on_event("shutdown")
async def shutdown_event():
    await shutdown_waha()
```

### **3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

```env
# .env —Ñ–∞–π–ª
WAHA_SERVER_URL=http://localhost:3000
WAHA_WEBHOOK_BASE_URL=http://your-server.com
WAHA_MAX_MESSAGES_PER_DAY=1000
WAHA_MESSAGE_DELAY_SECONDS=1.0
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞:**

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ WAHA
curl -X POST "http://localhost:8000/waha/settings/{store_id}" \
  -H "Content-Type: application/json" \
  -d '{
    "waha_server_url": "http://localhost:3000",
    "waha_session_name": "kaspi-session",
    "is_enabled": true,
    "webhook_url": "http://your-server.com/webhook/waha"
  }'
```

### **2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WhatsApp:**

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
curl -X POST "http://localhost:8000/waha/sessions/connect/{store_id}" \
  -H "Content-Type: application/json" \
  -d '{"webhook_url": "http://your-server.com/webhook/waha"}'
```

### **3. –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞:**

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
curl -X POST "http://localhost:8000/waha/templates/{store_id}" \
  -H "Content-Type: application/json" \
  -d '{
    "template_name": "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–∫–∞–∑–µ",
    "template_text": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_name}! –í–∞—à –∑–∞–∫–∞–∑ N¬∫ {order_num} –≥–æ—Ç–æ–≤ –∫ —Å–∞–º–æ–≤—ã–≤–æ–∑—É. –° —É–≤–∞–∂–µ–Ω–∏–µ–º, {shop_name}"
  }'
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

1. **–í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `whatsapp_messages_log`
2. **–û—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏** –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã
3. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ webhook
4. **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
curl http://localhost:8000/waha/health

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
curl http://localhost:8000/waha/statistics/{store_id}

# –õ–æ–≥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
curl http://localhost:8000/waha/logs/{store_id}
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### **–¢–∏–ø—ã –æ—à–∏–±–æ–∫ –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞:**

1. **WAHA —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** ‚Üí –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
2. **–°–µ—Å—Å–∏—è WhatsApp –æ—Ç–∫–ª—é—á–µ–Ω–∞** ‚Üí –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. **–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞** ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–æ–ø—É—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
4. **–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏** ‚Üí –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
5. **–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤** ‚Üí –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

### **Graceful degradation:**

–°–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–∫, —á—Ç–æ –µ—Å–ª–∏ WAHA –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å Kaspi Demper –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —Å–±–æ–µ–≤.

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–æ–æ–±—â–µ–Ω–∏—è

```
1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏–∑ Kaspi API
   ‚Üì
2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
   ‚Üì
3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
   ‚Üì
4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
   ‚Üì
5. –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —à–∞–±–ª–æ–Ω
   ‚Üì
6. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   ‚Üì
7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ WAHA —Å–µ—Å—Å–∏–∏
   ‚Üì
8. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WAHA API
   ‚Üì
9. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   ‚Üì
10. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç:

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—Ç—å** –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ Kaspi API
2. **–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å** —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã (—Å—Ç–∞—Ç—É—Å NEW, CONFIRMED, PROCESSING)
3. **–ò–∑–≤–ª–µ–∫–∞—Ç—å** –¥–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, —Ç–æ–≤–∞—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
4. **–§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å** –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —à–∞–±–ª–æ–Ω—É
5. **–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ WhatsApp –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
6. **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å** –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
7. **–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å** —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ —á–µ—Ä–µ–∑ webhook
8. **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å** —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –º–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ API

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üöÄ
