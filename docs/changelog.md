# Changelog - Kaspi Demper Project

# Changelog - Kaspi Demper Project

## [2025-11-13] - Отключение проверки подписки
### Добавлено
- Логирование состояния подписки при авторизации пользователей Kaspi

### Изменено
- Проверка активной подписки полностью отключена на уровне backend (`utils.has_active_subscription`)
- Актуализированы версии API роутеров FastAPI с единым префиксом `/api/v1`

### Исправлено
- Ошибка авторизации магазинов без активной подписки

## [2025-01-27] - Интеграция WAHA WhatsApp и улучшения Kaspi API

### Добавлено
- Полная интеграция с WAHA WhatsApp API для автоматизации сообщений
- Новые компоненты для управления шаблонами WhatsApp сообщений
- Улучшенная обработка данных Kaspi с AI-анализом товаров
- Обновленные сервисы для работы с продажами и предзаказами
- Добавлен unified-backend для централизованной обработки данных
- Улучшена архитектура проекта с новыми хуками и контекстами
- Новые тестовые файлы для проверки интеграций
- Обновленная конфигурация API endpoints
- Улучшенные сервисы для работы с демпером и прокси

### Изменено
- Обновлена структура компонентов WhatsApp интеграции
- Улучшена обработка данных продаж
- Модифицированы страницы для лучшего UX
- Обновлены сервисы для работы с Kaspi API

### Исправлено
- Устранены проблемы с интеграцией WAHA
- Исправлена обработка ошибок в API запросах
- Улучшена стабильность работы с Kaspi

## [2025-01-27] - Создание Unified Backend

### Добавлено
- Создан объединенный бэкенд `unified-backend/` с модульной архитектурой
- Реализована двойная система авторизации (Selenium + Playwright) с автоматическим fallback
- Создан гибкий database layer с поддержкой Supabase и PostgreSQL
- Перенесены и адаптированы API routes из kaspi-demper-main
- Интегрированы сервисы: демпер, прокси, error handling, логирование
- Настроен Docker с двумя режимами развертывания (Lite + Full)
- Создана полная документация по развертыванию и миграции
- Реализованы Pydantic модели для валидации данных
- Добавлена система логирования с цветным выводом
- Созданы утилиты для работы с данными
- **Добавлен автоматический демпер цен** с умным алгоритмом и настраиваемыми параметрами
- **Интегрирована продвинутая прокси система** с балансировкой нагрузки и статистикой
- **Созданы API endpoints** для управления демпером и прокси системой
- **Добавлен мониторинг и логирование** для всех компонентов системы
- **Созданы примеры использования API** для демпера и прокси

### Изменено
- Объединены лучшие части обоих бэкендов в единую архитектуру
- Упрощен процесс развертывания с двумя режимами работы
- Улучшена совместимость с фронтендом

### Исправлено
- Устранены конфликты между разными бэкендами
- Улучшена совместимость с фронтендом
- Решены проблемы с зависимостями

## [2025-01-27] - Анализ проекта Kaspi Demper

### Добавлено
- Полный анализ архитектуры системы Kaspi Demper
- Документация по всем основным компонентам системы
- Описание API эндпоинтов и их функционала
- Анализ системы аутентификации и управления магазинами
- Документация по системе демпинга цен
- Описание парсинга Kaspi API
- Анализ системы прокси и балансировки нагрузки
- Документация по управлению предзаказами
- Описание аналитики и отчетности
- Анализ административной панели
- Документация по базе данных и схемам таблиц
- Описание системы безопасности и ограничений
- Анализ возможностей масштабирования
- Документация по мониторингу и логированию
- Описание процесса развертывания

### Изменено
- Структурирована документация проекта
- Улучшена читаемость технической документации
- Добавлены детальные описания всех модулей

### Исправлено
- Отсутствие технической документации по проекту
- Недостаток понимания архитектуры системы

## Технические детали проекта

### Основные модули системы:

#### 1. FastAPI Backend (main.py)
- **Назначение**: Основной веб-сервер системы
- **Функции**: 
  - Обработка HTTP-запросов
  - Аутентификация пользователей
  - Управление магазинами Kaspi
  - Синхронизация товаров
  - Обработка предзаказов
- **Технологии**: FastAPI, Pydantic, Supabase
- **Порт**: 8010

#### 2. Demper Bot (demper.py, demper_instance.py)
- **Назначение**: Автоматический демпер цен
- **Функции**:
  - Мониторинг цен конкурентов
  - Автоматическое снижение цен
  - Обновление цен в Kaspi
  - Поддержка шардинга
- **Технологии**: asyncio, asyncpg
- **Особенности**: Асинхронная обработка, ограничение нагрузки

#### 3. API Parser (api_parser.py)
- **Назначение**: Парсинг Kaspi API
- **Функции**:
  - Получение цен конкурентов
  - Обновление цен товаров
  - Синхронизация товаров магазина
  - Управление сессиями
- **Технологии**: Playwright, aiohttp, requests
- **Особенности**: Автоматизация браузера, обработка ошибок

#### 4. Database Layer (db.py)
- **Назначение**: Работа с PostgreSQL
- **Функции**:
  - Пул соединений
  - Асинхронные запросы
  - Управление транзакциями
- **Технологии**: asyncpg
- **Конфигурация**: Синглтон пул соединений

#### 5. Proxy System (proxy_balancer.py)
- **Назначение**: Балансировка прокси
- **Функции**:
  - Round-robin распределение
  - Привязка прокси к пользователям
  - Статистика использования
- **Особенности**: Автоматический сброс счетчиков

#### 6. Error Handling (error_handlers.py)
- **Назначение**: Обработка ошибок
- **Функции**:
  - Скриншоты ошибок
  - Повторные попытки
  - Обработка различных типов ошибок
- **Технологии**: Playwright, asyncio

### API Эндпоинты Kaspi:

#### Аутентификация:
- `https://idmc.shop.kaspi.kz/login` - страница входа
- `https://mc.shop.kaspi.kz/s/m` - получение списка магазинов
- `https://mc.shop.kaspi.kz/mc/facade/graphql` - информация о магазине

#### Товары и цены:
- `https://kaspi.kz/yml/offer-view/offers/{sku}` - цены конкурентов
- `https://mc.shop.kaspi.kz/pricefeed/upload/merchant/process` - обновление цены
- `https://mc.shop.kaspi.kz/bff/offer-view/list` - товары магазина

#### Заказы и аналитика:
- `https://mc.shop.kaspi.kz/mc/api/orderTabs/active` - активные заказы
- `https://kaspi.kz/yml/review-view/api/v1/reviews/product/{product_id}` - отзывы

### База данных:

#### Таблица kaspi_stores:
```sql
CREATE TABLE kaspi_stores (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    merchant_id VARCHAR NOT NULL,
    name VARCHAR NOT NULL,
    api_key VARCHAR DEFAULT 'auto_generated_token',
    products_count INTEGER DEFAULT 0,
    last_sync TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    guid JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### Таблица products:
```sql
CREATE TABLE products (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES kaspi_stores(id),
    kaspi_product_id VARCHAR NOT NULL,
    kaspi_sku VARCHAR,
    name VARCHAR NOT NULL,
    price DECIMAL NOT NULL,
    category VARCHAR,
    image_url VARCHAR,
    external_kaspi_id VARCHAR,
    bot_active BOOLEAN DEFAULT FALSE,
    min_profit DECIMAL,
    max_profit DECIMAL,
    strategy VARCHAR,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### Таблица preorders:
```sql
CREATE TABLE preorders (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES kaspi_stores(id),
    product_id UUID REFERENCES products(id),
    article VARCHAR NOT NULL,
    name VARCHAR NOT NULL,
    brand VARCHAR,
    price DECIMAL NOT NULL,
    warehouses JSONB,
    delivery_days INTEGER DEFAULT 30,
    status VARCHAR DEFAULT 'processing',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Переменные окружения:

#### Основные настройки:
- `SUPABASE_URL` - URL Supabase
- `SUPABASE_KEY` - ключ Supabase
- `INSTANCE_INDEX` - индекс шарда (0..N-1)
- `INSTANCE_COUNT` - общее количество шардов
- `MAX_CONCURRENT_TASKS` - лимит параллельных задач
- `SYNC_STORES_MODE` - режим синхронизации (leader/shard)

#### Настройки базы данных:
- `DB_USER` - пользователь PostgreSQL
- `DB_PASSWORD` - пароль PostgreSQL
- `DB_NAME` - имя базы данных
- `DB_HOST` - хост базы данных
- `DB_PORT` - порт базы данных

### Алгоритм демпинга:

1. **Получение активных товаров** из БД
2. **Для каждого товара**:
   - Парсинг цен конкурентов через Kaspi API
   - Сравнение с текущей ценой
   - Если цена выше конкурентов - снижение на 1 тенге
   - Обновление цены в Kaspi
3. **Синхронизация магазина** после обновления цен
4. **Пауза** перед следующим циклом (5 секунд)

### Система безопасности:

#### Ограничения:
- Проверка активной подписки пользователя
- Ограничение на количество товаров без подписки (20)
- Валидация сессий Kaspi
- Rate limiting для избежания блокировок

#### Прокси система:
- Ротация прокси для распределения нагрузки
- Привязка прокси к пользователям
- Статистика использования прокси
- Автоматический сброс счетчиков

### Мониторинг:

#### Health Checks:
- `/health` - статус FastAPI
- `/health/supabase` - статус Supabase
- `/health/db` - статус базы данных
- `/admin/system/status` - статус системы
- `/admin/system/health` - здоровье сервисов

#### Логирование:
- Структурированные логи с временными метками
- Различные уровни логирования (INFO, WARNING, ERROR)
- Фильтрация HTTP-запросов для читаемости
- Отдельные логи для демпера и API

### Развертывание:

#### Docker:
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8010"]
```

#### Docker Compose:
```yaml
version: '3.8'
services:
  backend:
    build: .
    ports:
      - "8010:8010"
    environment:
      - INSTANCE_INDEX=0
      - INSTANCE_COUNT=1
    volumes:
      - ./logs:/app/logs
```

### Производительность:

#### Оптимизации:
- Асинхронная обработка товаров
- Пул соединений к БД
- Семафоры для ограничения нагрузки
- Кэширование сессий
- Пакетная обработка товаров

#### Масштабирование:
- Поддержка множественных инстансов
- Шардинг по товарам
- Распределенная синхронизация магазинов
- Горизонтальное масштабирование

### Заключение:

Kaspi Demper представляет собой высокопроизводительную систему автоматического демпинга цен с продуманной архитектурой, включающей все необходимые компоненты для работы в продакшене:

- Надежную систему аутентификации
- Эффективный парсинг Kaspi API
- Автоматизированный демпер с настраиваемыми стратегиями
- Систему управления предзаказами
- Комплексный мониторинг и аналитику
- Возможности масштабирования и шардинга

Система спроектирована с учетом ограничений API Kaspi и необходимости избежания блокировок, что делает её готовой для коммерческого использования.
