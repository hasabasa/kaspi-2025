# Анализ проекта Kaspi Demper

## Обзор проекта

**Kaspi Demper** - это система автоматического демпинга цен на платформе Kaspi.kz. Проект представляет собой backend-систему на FastAPI с автоматизированным ботом для мониторинга и корректировки цен товаров в реальном времени.

## Архитектура системы

### Основные компоненты

1. **FastAPI Backend** (`main.py`) - основной веб-сервер
2. **Demper Bot** (`demper.py`, `demper_instance.py`) - автоматический демпер цен
3. **API Parser** (`api_parser.py`) - парсер Kaspi API
4. **Database Layer** (`db.py`) - работа с PostgreSQL
5. **Proxy System** (`proxy_balancer.py`) - балансировка прокси
6. **Error Handling** (`error_handlers.py`) - обработка ошибок

### Технологический стек

- **Backend**: FastAPI, Python 3.8+
- **Database**: PostgreSQL (asyncpg)
- **Web Scraping**: Playwright, aiohttp, requests
- **Authentication**: Supabase
- **Proxy Management**: Кастомная система балансировки
- **Data Processing**: pandas, openpyxl

## Основной функционал

### 1. Аутентификация и управление магазинами

**Эндпоинты:**
- `POST /kaspi/auth` - аутентификация магазина через email/password
- `POST /kaspi/auth/sms/start` - начало SMS-авторизации
- `POST /kaspi/auth/sms/verify` - завершение SMS-авторизации
- `GET /kaspi/stores` - получение списка магазинов пользователя
- `POST /kaspi/stores/{store_id}/sync` - синхронизация товаров магазина

**Процесс аутентификации:**
1. Пользователь вводит email/password или номер телефона
2. Система использует Playwright для автоматического входа в Kaspi
3. Сохраняются cookies и session данные
4. Извлекается merchant_id и название магазина
5. Данные сохраняются в PostgreSQL

### 2. Управление товарами

**Эндпоинты:**
- `GET /products/` - список товаров с пагинацией и фильтрацией
- `POST /products/batch_enable` - массовое включение ботов
- `POST /products/batch_disable` - массовое отключение ботов
- `PUT /products/{product_id}/strategy` - настройка стратегии ценообразования
- `GET /products/store_stats` - статистика по магазину

**Функции товаров:**
- Мониторинг цен конкурентов
- Автоматическое снижение цен
- Настройка минимальной/максимальной прибыли
- Стратегии ценообразования

### 3. Система демпинга (Demper Bot)

**Основной алгоритм:**
1. Получение списка активных товаров из БД
2. Для каждого товара:
   - Парсинг цен конкурентов через Kaspi API
   - Сравнение с текущей ценой
   - Если цена выше конкурентов - снижение на 1 тенге
   - Обновление цены в Kaspi
3. Синхронизация магазина после обновления цен

**Особенности реализации:**
- Асинхронная обработка товаров
- Ограничение количества одновременных запросов (semaphore)
- Случайные задержки между запросами
- Поддержка шардинга для масштабирования

### 4. Парсинг Kaspi API

**Основные функции:**
- `parse_product_by_sku()` - получение цен конкурентов по SKU
- `sync_product()` - обновление цены товара
- `get_products()` - получение списка товаров магазина
- `sync_store_api()` - синхронизация всего магазина

**API эндпоинты Kaspi:**
- `https://kaspi.kz/yml/offer-view/offers/{sku}` - цены конкурентов
- `https://mc.shop.kaspi.kz/pricefeed/upload/merchant/process` - обновление цены
- `https://mc.shop.kaspi.kz/bff/offer-view/list` - товары магазина

### 5. Система прокси

**ProxyBalancer класс:**
- Round-robin распределение запросов
- Привязка прокси к пользователям
- Статистика использования
- Автоматический сброс счетчиков

### 6. Предзаказы (Preorders)

**Функционал:**
- Создание предзаказов из товаров
- Управление складами (PP1-PP5)
- Экспорт в Excel
- Загрузка на Kaspi

**Эндпоинты:**
- `POST /kaspi/preorders/create` - создание предзаказа
- `GET /kaspi/preorders/list/{store_id}` - список предзаказов
- `POST /kaspi/preorders/upload/{store_id}` - загрузка на Kaspi
- `POST /kaspi/preorders/generate-excel/{store_id}` - генерация Excel

### 7. Аналитика и отчеты

**Функции:**
- Анализ отзывов и оценка продаж
- Статистика по заказам
- Топ товаров по продажам
- Метрики эффективности

**Эндпоинты:**
- `POST /kaspi/reviews` - анализ отзывов товара
- `GET /kaspi/get_sells_info/{shop_id}` - статистика продаж

### 8. Административная панель

**Мониторинг системы:**
- Статус сервисов
- Статистика базы данных
- Использование ресурсов
- Процессы системы

**Эндпоинты:**
- `GET /admin/system/status` - статус системы
- `GET /admin/system/stats` - статистика backend
- `GET /admin/system/health` - здоровье сервисов
- `GET /admin/system/database` - статистика БД

## База данных

### Основные таблицы:

1. **kaspi_stores** - магазины пользователей
   - id, user_id, merchant_id, name, api_key
   - products_count, last_sync, is_active

2. **products** - товары магазинов
   - id, store_id, kaspi_product_id, kaspi_sku
   - name, price, category, image_url
   - bot_active, min_profit, max_profit, strategy

3. **preorders** - предзаказы
   - id, store_id, product_id, article, name
   - price, warehouses, delivery_days, status

## Безопасность и ограничения

### Аутентификация:
- Проверка активной подписки пользователя
- Валидация сессий Kaspi
- Ограничения на количество товаров без подписки

### Rate Limiting:
- Случайные задержки между запросами
- Ограничение одновременных запросов
- Обработка ошибок 429 (Too Many Requests)

### Прокси система:
- Ротация прокси для избежания блокировок
- Балансировка нагрузки
- Статистика использования

## Масштабирование

### Шардинг:
- Поддержка множественных инстансов демпера
- Распределение товаров по шардам
- Настраиваемые параметры через переменные окружения

### Параллелизм:
- Асинхронная обработка товаров
- Пул соединений к БД
- Семафоры для ограничения нагрузки

## Мониторинг и логирование

### Логирование:
- Структурированные логи с временными метками
- Различные уровни логирования
- Фильтрация HTTP-запросов для читаемости

### Мониторинг:
- Health checks для всех сервисов
- Статистика производительности
- Отслеживание ошибок и исключений

## Развертывание

### Docker:
- Dockerfile для контейнеризации
- docker-compose.yml для оркестрации
- Настройка через переменные окружения

### Переменные окружения:
- `INSTANCE_INDEX` - индекс шарда
- `INSTANCE_COUNT` - общее количество шардов
- `MAX_CONCURRENT_TASKS` - лимит параллельных задач
- `SYNC_STORES_MODE` - режим синхронизации магазинов

## Заключение

Kaspi Demper представляет собой комплексную систему автоматического демпинга цен с продуманной архитектурой, включающей:

- Надежную систему аутентификации
- Эффективный парсинг Kaspi API
- Автоматизированный демпер с настраиваемыми стратегиями
- Систему управления предзаказами
- Комплексный мониторинг и аналитику
- Возможности масштабирования и шардинга

Система спроектирована для работы в продакшене с учетом ограничений API Kaspi и необходимости избежания блокировок.
