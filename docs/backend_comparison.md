# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±—ç–∫–µ–Ω–¥–æ–≤: unified-backend vs kaspi-demper-main/backend

## üìä –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

**unified-backend** - —ç—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π** –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞.
**kaspi-demper-main/backend** - —ç—Ç–æ **—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è**, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

---

## üîç –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | unified-backend | kaspi-demper-main/backend |
|----------|----------------|--------------------------|
| **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** | ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —á–µ—Ä–µ–∑ `config.py` (Pydantic Settings) | ‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ –∫–æ–¥—É |
| **CORS** | ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `settings.CORS_ALLOWED_ORIGINS` | ‚ùå –ñ–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω –≤ `main.py` |
| **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** | ‚úÖ –£–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Pydantic | ‚ùå –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ `os.getenv()` |

### 2. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –§—É–Ω–∫—Ü–∏—è | unified-backend | kaspi-demper-main/backend |
|---------|----------------|--------------------------|
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏** | ‚úÖ **–û–¢–ö–õ–Æ–ß–ï–ù–ê** (`has_active_subscription` —É–¥–∞–ª–µ–Ω–∞) | ‚ùå **–í–ö–õ–Æ–ß–ï–ù–ê** (–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) |
| **WAHA –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | ‚úÖ –ï—Å—Ç—å –≤ `config.py` | ‚ùå –ù–µ—Ç |
| **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å (`migrations/`) |
| **–°–∫—Ä–∏–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å (`scripts/`) |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | ‚úÖ –ë–∞–∑–æ–≤–∞—è | ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è (MIGRATION_CHECKLIST, QUICK_START) |

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | unified-backend | kaspi-demper-main/backend |
|-----------|----------------|--------------------------|
| **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (`VITE_API_URL=http://localhost:8010`) | ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞** | ‚úÖ –£–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ `changelog.md`, `UNIFIED_BACKEND_SETUP.md` | ‚ùå –ù–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è |
| **README** | ‚úÖ –ï—Å—Ç—å | ‚ùå –ù–µ—Ç |

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### unified-backend
```
unified-backend/
‚îú‚îÄ‚îÄ main.py              # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ config.py            # ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ api_parser.py        # –ü–∞—Ä—Å–µ—Ä Kaspi API
‚îú‚îÄ‚îÄ db.py                # Database layer
‚îú‚îÄ‚îÄ demper.py            # –î–µ–º–ø–µ—Ä —Ü–µ–Ω
‚îú‚îÄ‚îÄ routes/              # API routes
‚îÇ   ‚îú‚îÄ‚îÄ kaspi.py
‚îÇ   ‚îú‚îÄ‚îÄ products.py
‚îÇ   ‚îî‚îÄ‚îÄ admin.py
‚îú‚îÄ‚îÄ services/            # –°–µ—Ä–≤–∏—Å—ã
‚îî‚îÄ‚îÄ README.md            # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

### kaspi-demper-main/backend
```
kaspi-demper-main/backend/
‚îú‚îÄ‚îÄ main.py              # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
‚îú‚îÄ‚îÄ main_with_ai.py      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å AI
‚îú‚îÄ‚îÄ api_parser.py        # –ü–∞—Ä—Å–µ—Ä Kaspi API
‚îú‚îÄ‚îÄ db.py                # Database layer
‚îú‚îÄ‚îÄ demper.py            # –î–µ–º–ø–µ—Ä —Ü–µ–Ω
‚îú‚îÄ‚îÄ routes/              # API routes
‚îú‚îÄ‚îÄ migrations/          # ‚úÖ SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ 001_add_last_check_time.sql
‚îÇ   ‚îú‚îÄ‚îÄ 002_check_index_performance.sql
‚îÇ   ‚îî‚îÄ‚îÄ 003_maintenance_vacuum.sql
‚îú‚îÄ‚îÄ scripts/             # ‚úÖ –°–∫—Ä–∏–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ initialize_last_check_time.py
‚îÇ   ‚îî‚îÄ‚îÄ maintenance_cronjob.sh
‚îú‚îÄ‚îÄ MIGRATION_CHECKLIST.md  # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ QUICK_START_526_FIX.md  # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ start_dempers.sh     # ‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
```

---

## ‚úÖ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ kaspi-demper-main/backend

### 1. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (–≤–∞–∂–Ω–æ!)
```bash
kaspi-demper-main/backend/migrations/
‚îú‚îÄ‚îÄ 001_add_last_check_time.sql      # –î–æ–±–∞–≤–ª—è–µ—Ç last_check_time –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ 002_check_index_performance.sql  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–æ–≤
‚îî‚îÄ‚îÄ 003_maintenance_vacuum.sql       # –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ë–î
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `unified-backend/migrations/` –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ —Ñ–∞–π–ª—ã.

### 2. –°–∫—Ä–∏–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
```bash
kaspi-demper-main/backend/scripts/
‚îú‚îÄ‚îÄ initialize_last_check_time.py    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è last_check_time
‚îî‚îÄ‚îÄ maintenance_cronjob.sh          # Cronjob –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `unified-backend/scripts/` –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ —Ñ–∞–π–ª—ã.

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```bash
kaspi-demper-main/backend/
‚îú‚îÄ‚îÄ MIGRATION_CHECKLIST.md           # –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
‚îî‚îÄ‚îÄ QUICK_START_526_FIX.md           # –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ `unified-backend/docs/` –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ —Å–ø—Ä–∞–≤–æ—á–Ω—É—é.

### 4. –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –¥–µ–º–ø–µ—Ä–æ–≤
```bash
kaspi-demper-main/backend/start_dempers.sh
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è unified-backend –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å: unified-backend
**–ü—Ä–∏—á–∏–Ω—ã:**
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –Ω–µ–≥–æ)
2. ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ (–∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
4. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAHA –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
5. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### ‚ùå –£–¥–∞–ª–∏—Ç—å: kaspi-demper-main/backend
**–ü—Ä–∏—á–∏–Ω—ã:**
1. ‚ùå –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
2. ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
3. ‚ùå –î—É–±–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å unified-backend
4. ‚ùå –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ù–û:** –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–º–∏–≥—Ä–∞—Ü–∏–∏, —Å–∫—Ä–∏–ø—Ç—ã).

---

## üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –®–∞–≥ 1: –ü–µ—Ä–µ–Ω–æ—Å –º–∏–≥—Ä–∞—Ü–∏–π
```bash
mkdir -p unified-backend/migrations
cp -r kaspi-demper-main/backend/migrations/* unified-backend/migrations/
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–Ω–æ—Å —Å–∫—Ä–∏–ø—Ç–æ–≤
```bash
mkdir -p unified-backend/scripts
cp -r kaspi-demper-main/backend/scripts/* unified-backend/scripts/
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–Ω–æ—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
```bash
cp kaspi-demper-main/backend/MIGRATION_CHECKLIST.md unified-backend/docs/
cp kaspi-demper-main/backend/QUICK_START_526_FIX.md unified-backend/docs/
```

### –®–∞–≥ 4: –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–ø—É—Å–∫–∞
```bash
# –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å start_dempers.sh –¥–ª—è unified-backend
# –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
```

### –®–∞–≥ 5: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞
```bash
# –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
rm -rf kaspi-demper-main/backend/
```

---

## üîç –î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

### main.py - CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**unified-backend:**
```python
from config import settings

app.add_middleware(
    CORSMiddleware,
    allow_origin_regex=settings.CORS_ALLOWED_ORIGINS,  # ‚úÖ –ò–∑ –∫–æ–Ω—Ñ–∏–≥–∞
    ...
)
```

**kaspi-demper-main/backend:**
```python
app.add_middleware(
    CORSMiddleware,
    allow_origin_regex=(
        r"^(https:\/\/([a-z0-9-]+\.)?(kaspi-price\.kz|mark-bot\.kz)"
        r"|http:\/\/localhost(:\d+)?)$"  # ‚ùå –ñ–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ
    ),
    ...
)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏

**unified-backend:**
```python
from utils import has_existing_store  # ‚úÖ –ë–µ–∑ has_active_subscription
```

**kaspi-demper-main/backend:**
```python
from utils import has_active_subscription, has_existing_store  # ‚ùå –° –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∫–∏

# –í –∫–æ–¥–µ:
if not await has_active_subscription(user_id):  # ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    raise HTTPException(...)
```

---

## üìù –í—ã–≤–æ–¥—ã

1. **unified-backend** - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±—ç–∫–µ–Ω–¥
2. **kaspi-demper-main/backend** - —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
3. –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏, —Å–∫—Ä–∏–ø—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
4. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –±—ç–∫–µ–Ω–¥

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-12-09
**–°—Ç–∞—Ç—É—Å:** unified-backend - –æ—Å–Ω–æ–≤–Ω–æ–π –±—ç–∫–µ–Ω–¥ –ø—Ä–æ–µ–∫—Ç–∞


