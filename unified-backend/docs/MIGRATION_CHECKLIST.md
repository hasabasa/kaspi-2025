# –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã 526

## ‚úÖ –ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏

- [ ] –°–¥–µ–ª–∞—Ç—å backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –¥–µ–º–ø–µ—Ä—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é PostgreSQL (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å >= 12)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

## üìã –®–∞–≥–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
cd /Users/hasa/Downloads/huilo-667-45/kaspi-demper-main/backend

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
psql -U your_user -d your_database -f migrations/001_add_last_check_time.sql
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–æ–ª–æ–Ω–∫–∞ `last_check_time` –¥–æ–±–∞–≤–ª–µ–Ω–∞
- –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- –¢–æ–≤–∞—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (last_check_time —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
SELECT 
    COUNT(*) as total_active,
    COUNT(*) FILTER (WHERE last_check_time IS NULL) as never_checked,
    COUNT(*) FILTER (WHERE last_check_time IS NOT NULL) as initialized
FROM products 
WHERE bot_active = TRUE;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `never_checked` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 –∏–ª–∏ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–º (< 100)
- `initialized` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–ª–∏–∑–∫–æ –∫ `total_active`

**–ï—Å–ª–∏ `never_checked` > 100:**
```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
python3 scripts/initialize_last_check_time.py
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤

```bash
psql -U your_user -d your_database -f migrations/002_check_index_performance.sql
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `EXPLAIN ANALYZE` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Index Scan using idx_products_bot_active_last_check"
- –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "Seq Scan" (–ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã)

**–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Seq Scan":**
1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `ANALYZE products;`
2. –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–π—Ç–µ: `REINDEX INDEX idx_products_bot_active_last_check;`
3. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ

```sql
-- –°–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?
SELECT COUNT(*) 
FROM products 
WHERE bot_active = TRUE
  AND last_check_time IS NOT NULL
  AND last_check_time < NOW() - make_interval(secs => 30);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –î–ª—è –Ω–∞—á–∞–ª–∞: 100-500 —Ç–æ–≤–∞—Ä–æ–≤ (—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã)
- –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ü–∏–∫–ª–∞: –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

**–ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç > 5000:**
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
- –ò–õ–ò —É–≤–µ–ª–∏—á—å—Ç–µ `CHECK_INTERVAL_SECONDS` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –®–∞–≥ 5: –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–ø–µ—Ä (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –û–î–ò–ù –∏–Ω—Å—Ç–∞–Ω—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
cd /Users/hasa/Downloads/huilo-667-45/kaspi-demper-main/backend

export MAX_CONCURRENT_TASKS=10
export DEMPER_INTERVAL=30
export CHECK_INTERVAL_SECONDS=30
export BATCH_SIZE=200

python3 demper.py
```

**–ù–∞–±–ª—é–¥–∞–π—Ç–µ:**
- –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ù–∞–π–¥–µ–Ω–æ X —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏" (X –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < 500)
- –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ 526
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ–ª–∂–Ω–∞ –∏–¥—Ç–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

**–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–µ–º–ø–µ—Ä (Ctrl+C)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ

### –®–∞–≥ 6: –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã (production)

```bash
# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã
cd /Users/hasa/Downloads/huilo-667-45/kaspi-demper-main/backend

export INSTANCE_COUNT=5
export MAX_CONCURRENT_TASKS=15
export DEMPER_INTERVAL=30

./start_dempers.sh
```

### –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É:
0 3 * * * /path/to/scripts/maintenance_cronjob.sh >> /var/log/demper_maintenance.log 2>&1
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ:

1. **–õ–æ–≥–∏ –¥–µ–º–ø–µ—Ä–∞:**
   ```bash
   tail -f logs/demper_*.log | grep -i error
   ```

2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–≤–∞—Ä–æ–≤:**
   ```sql
   SELECT 
       COUNT(*) FILTER (WHERE last_check_time IS NULL) as never_checked,
       COUNT(*) FILTER (WHERE last_check_time > NOW() - INTERVAL '1 hour') as checked_recently
   FROM products 
   WHERE bot_active = TRUE;
   ```

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤:**
   ```bash
   psql -U your_user -d your_database -f migrations/002_check_index_performance.sql
   ```

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Å–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–ü—Ä–∏—á–∏–Ω–∞:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –≤—Å–µ –∏–º–µ—é—Ç NULL

**–†–µ—à–µ–Ω–∏–µ:**
```bash
python3 scripts/initialize_last_check_time.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–Ω–¥–µ–∫—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (Seq Scan)

**–ü—Ä–∏—á–∏–Ω–∞:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–µ —Å–æ–∑–¥–∞–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```sql
ANALYZE products;
REINDEX INDEX idx_products_bot_active_last_check;
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ 526 –≤—Å–µ –µ—â–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ–º–ø–µ—Ä–∞ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –£–º–µ–Ω—å—à–∏—Ç–µ `MAX_CONCURRENT_TASKS` –¥–æ 10
- –£–≤–µ–ª–∏—á—å—Ç–µ `DEMPER_INTERVAL` –¥–æ 60
- –£–º–µ–Ω—å—à–∏—Ç–µ `BATCH_SIZE` –¥–æ 200

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–æ–≤–∞—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–ª–∏—à–∫–æ–º –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á—å—Ç–µ `INSTANCE_COUNT` –¥–æ 10
- –£–≤–µ–ª–∏—á—å—Ç–µ `MAX_CONCURRENT_TASKS` –¥–æ 20 (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
- –£–º–µ–Ω—å—à–∏—Ç–µ `CHECK_INTERVAL_SECONDS` –¥–æ 20

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (never_checked = 0 –∏–ª–∏ –æ—á–µ–Ω—å –º–∞–ª–æ)
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç (Index Scan –≤ EXPLAIN)
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ (–Ω–µ—Ç –æ—à–∏–±–æ–∫ 526)
- [ ] –í—Å–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã –∑–∞–ø—É—â–µ–Ω—ã
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (cronjob)

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `DEMPER_526_FIX.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
- `QUICK_START_526_FIX.md` - –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `migrations/README.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º

